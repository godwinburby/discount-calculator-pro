<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discount Calculator Pro</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for aesthetics and mobile feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-field {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }

        /* Desktop-specific styles for product row to enable tabular view */
        @media (min-width: 768px) {
            .product-row-desktop-grid {
                /* 9 Columns: Name, Price, Units, Subtotal, Discount Setup, Discount Amt, Discount %, Final Price, Remove Btn */
                grid-template-columns: 1.8fr 1fr 0.7fr 1fr 2fr 1fr 0.8fr 1.2fr auto; 
                display: grid;
                align-items: center;
                gap: 1rem;
                padding: 1rem 1.5rem;
            }
            .product-row .mobile-only-details {
                display: none; /* Hide stacked details on desktop */
            }
            /* Style for the calculated outputs */
            .calculated-output {
                font-size: 0.9rem;
                font-weight: 600;
                text-align: right;
                padding-right: 4px;
            }
            .calculated-output.final {
                font-size: 1rem;
                font-weight: 700;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto"> 
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Discount Calculator Pro</h1>
            <p class="text-gray-500">Manage multiple products and complex discounts easily with local quote storage.</p>
        </header>

        <main class="bg-white p-6 rounded-xl container-card space-y-6">
            
            <!-- Quote Management Section (New) -->
            <div class="border-b pb-4 mb-4 space-y-3">
                <h2 class="text-xl font-semibold text-gray-700">Quote Management (Local Storage)</h2>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <!-- Quote Name Input with Autocomplete -->
                    <div class="sm:flex-grow">
                        <input
                            type="text"
                            id="quote-name-input"
                            list="saved-quotes"
                            placeholder="Type or select a Quote Name..."
                            class="input-field w-full text-base font-medium"
                            onchange="handleQuoteNameChange(this.value)"
                            oninput="handleQuoteNameChange(this.value)"
                        />
                        <datalist id="saved-quotes">
                            <!-- Options populated by JS -->
                        </datalist>
                    </div>

                    <!-- Action Buttons -->
                    <button id="save-quote-btn" onclick="saveQuoteLocally()" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        üíæ Save Quote
                    </button>
                    <!-- NEW CLEAR BUTTON -->
                    <button id="clear-quote-btn" onclick="clearQuote()" class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        ‚ú® Clear Quote
                    </button>
                    <!-- END NEW CLEAR BUTTON -->
                    <button id="delete-quote-btn" onclick="deleteQuoteLocally()" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0" disabled>
                        üóëÔ∏è Delete Quote
                    </button>
                </div>
                <p id="local-storage-message" class="text-sm text-center text-gray-500 hidden">Quote loaded successfully.</p>
            </div>

            <!-- Product List Header (Desktop Only - 9 Columns) -->
            <div class="hidden md:grid md:grid-cols-[1.8fr_1fr_0.7fr_1fr_2fr_1fr_0.8fr_1.2fr_auto] gap-4 mb-2 p-4 border-b border-gray-300 font-semibold text-gray-600">
                <span>Product Name</span>
                <span>Unit Price (‚Çπ)</span>
                <span>Units</span>
                <span class="text-right">Subtotal (‚Çπ)</span>
                <span class="text-center">Discount Setup</span>
                <span class="text-right">Discount Amt (‚Çπ)</span>
                <span class="text-right">Discount %</span>
                <span class="text-right">Final Price (‚Çπ)</span>
                <span class="w-6"></span> <!-- Spacer for delete button -->
            </div>

            <!-- Product List Area -->
            <div id="product-list" class="space-y-4">
                <h2 class="text-xl font-semibold border-b pb-2 text-gray-700 md:hidden">Products</h2>
                <!-- Product rows will be inserted here -->
            </div>

            <!-- Action Button: DIRECT BINDING for reliability -->
            <button id="add-product-btn" onclick="addProduct()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 shadow-md">
                + Add New Product
            </button>

            <!-- Totals Summary Area -->
            <div id="totals-summary" class="pt-6 border-t border-gray-200 mt-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-700 text-center md:text-left">Summary</h2>
                <!-- Global Summary remains the same -->
                <div class="space-y-3 p-4 bg-gray-50 rounded-lg max-w-sm mx-auto"> 
                    
                    <div class="flex justify-between text-base">
                        <span class="text-gray-600">Total Subtotal:</span>
                        <span id="total-subtotal" class="font-medium text-gray-800">‚Çπ0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-base">
                        <span class="text-gray-600">Total Discount:</span>
                        <span id="total-discount" class="font-medium text-red-500">-‚Çπ0.00</span>
                    </div>

                    <div class="flex justify-between text-base">
                        <span class="text-gray-600">Total Discount Percentage:</span>
                        <span id="total-discount-percentage" class="font-medium text-red-500">0.00%</span>
                    </div>

                    <div class="flex justify-between text-xl font-bold pt-2 border-t border-gray-200">
                        <span class="text-gray-800">Grand Total:</span>
                        <span id="grand-total" class="text-indigo-600">‚Çπ0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons Container -->
            <div class="flex flex-col sm:flex-row gap-4 mt-4">
                
                <!-- WhatsApp Share Button -->
                <button id="share-whatsapp-btn" onclick="shareToWhatsapp()" class="w-full sm:w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg flex items-center justify-center space-x-2">
                    <!-- WhatsApp Icon (inline SVG for portability) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-white">
                        <path d="M12.03 2.01c-5.5 0-9.98 4.48-9.98 9.98 0 1.94.57 3.82 1.63 5.42l-1.63 5.96 6.13-1.6c1.55.84 3.32 1.28 5.12 1.28 5.5 0 9.98-4.48 9.98-9.98s-4.48-9.98-9.98-9.98zm4.73 13.92c-.22.56-.99.93-1.42 1.05-.4.11-.84.17-1.29.17-1.35 0-2.65-.5-3.64-1.32-.98-.82-1.74-2.13-1.74-3.48 0-.91.24-1.66.7-2.31.47-.64 1.15-1.07 1.94-1.25.79-.18 1.63-.08 2.37.52.75.6 1.17 1.48 1.17 2.44 0 .22-.04.42-.1.62-.07.2-.18.39-.34.56-.16.17-.35.3-.56.4-.2.11-.42.17-.65.17-.03 0-.05 0-.08 0l-.13-.02c-.52-.08-1.03-.3-1.5-.66-.47-.36-.88-.84-1.23-1.44-.06-.11-.11-.23-.15-.36-.04-.13-.05-.26-.05-.4 0-.32.13-.62.36-.85.23-.23.53-.36.85-.36.24 0 .47.05.69.15.22.1.42.25.58.44.17.2.26.43.26.69 0 .16-.03.32-.08.47-.05.15-.12.29-.2.43-.19.3-.43.56-.7.77l-.02.02c.48.37 1.03.66 1.62.86.6.2 1.24.29 1.9.29.13 0 .26-.01.39-.03.74-.12 1.34-.5 1.8-1.14.47-.64.7-1.4.7-2.28 0-.82-.26-1.5-.77-2.04-.51-.55-1.22-.84-2.12-.84h-1.5c-.32 0-.62-.13-.85-.36-.23-.23-.53-.36-.85-.36 0-.32.13-.62.36-.85.23-.23.53-.36.85-.36h1.5c.9 0 1.76.27 2.47.81.71.54 1.1 1.25 1.1 2.08 0 .5-.08.98-.24 1.44-.16.46-.37.88-.63 1.26z"/>
                    </svg>
                    <span>Share via WhatsApp</span>
                </button>

                <!-- Copy Text Button -->
                <button id="copy-quote-btn" onclick="copyToClipboard()" class="w-full sm:w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg flex items-center justify-center space-x-2">
                    <!-- Copy Icon (inline SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zm4 0v4a1 1 0 01-1 1H9a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zm4 0v4a1 1 0 01-1 1h-3a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zM7 16h10" />
                    </svg>
                    <span>Copy Price Quote</span>
                </button>
            </div>

            <!-- Custom message box for UI feedback -->
            <div id="message-box" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 bg-blue-600 text-white rounded-lg shadow-xl hidden z-50 transition-opacity duration-300"></div>

        </main>
    </div>

    <script>
        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Product state array
        let products = [];
        let nextProductId = 1;

        // Quote Management state
        let currentQuoteName = '';

        const productListEl = document.getElementById('product-list');
        const totalSubtotalEl = document.getElementById('total-subtotal');
        const totalDiscountEl = document.getElementById('total-discount');
        const grandTotalEl = document.getElementById('grand-total');
        const totalDiscountPercentageEl = document.getElementById('total-discount-percentage');
        
        const quoteNameInputEl = document.getElementById('quote-name-input');
        const savedQuotesDatalistEl = document.getElementById('saved-quotes');
        const deleteQuoteBtnEl = document.getElementById('delete-quote-btn');
        const messageBoxEl = document.getElementById('message-box');

        /**
         * Shows a temporary message box for user feedback (e.g., successful save).
         */
        function showMessage(message, type = 'success') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            messageBoxEl.textContent = message;
            messageBoxEl.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-lg shadow-xl z-50 ${colors[type]}`;
            messageBoxEl.style.opacity = '1';
            messageBoxEl.style.display = 'block';

            setTimeout(() => {
                messageBoxEl.style.opacity = '0';
                setTimeout(() => {
                    messageBoxEl.style.display = 'none';
                }, 300);
            }, 3000);
        }

        /**
         * Helper to get the correct placeholder based on discount type.
         */
        function getPlaceholder(type) {
            switch (type) {
                case 'percentage': return 'Discount % (e.g., 10)';
                case 'amount': return 'Discount Amount (‚Çπ)';
                case 'final': return 'Discounted Final Price (‚Çπ)';
                default: return 'Enter value';
            }
        }

        /**
         * Generates the HTML string for a single product row.
         */
        function renderProductRow(product) {
            const { id, name, unitPrice, units, discountType, discountValue, subtotal, discountedPrice, discountAmount, discountPercentage } = product;
            const format = (value) => value.toFixed(2);

            return `
                <!-- Responsive Product Row Container -->
                <div id="product-${id}" 
                     class="product-row bg-white border border-gray-200 rounded-xl shadow-sm space-y-3 p-4 md:p-0 md:border-0 md:shadow-none md:space-y-0 md:border-t md:first:border-t-0 product-row-desktop-grid">
                    
                    <!-- 1. Product Name (Desktop Column 1) -->
                    <div class="md:col-span-1">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Product Name</span>
                            <input
                                type="text"
                                placeholder="Product Name (e.g., Laptop)"
                                value="${name}"
                                data-id="${id}"
                                data-field="name"
                                class="input-field text-lg font-semibold w-full"
                                oninput="handleInput(event)"
                            />
                        </label>
                    </div>

                    <!-- 2. Unit Price (Desktop Column 2) -->
                    <div class="md:col-span-1 md:block">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Unit Price (‚Çπ)</span>
                            <input
                                type="number"
                                min="0"
                                step="0.01"
                                value="${unitPrice}"
                                data-id="${id}"
                                data-field="unitPrice"
                                class="input-field w-full product-unit-price-${id}"
                                oninput="handleInput(event)"
                            />
                        </label>
                    </div>

                    <!-- 3. Units (Desktop Column 3) -->
                    <div class="md:col-span-1 md:block">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Units</span>
                            <input
                                type="number"
                                min="1"
                                step="1"
                                value="${units}"
                                data-id="${id}"
                                data-field="units"
                                class="input-field w-full"
                                oninput="handleInput(event)"
                            />
                        </label>
                    </div>
                    
                    <!-- 4. Subtotal (Desktop Column 4) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-gray-700" id="subtotal-display-desktop-${id}">
                            ‚Çπ${subtotal.toFixed(2)}
                        </div>
                    </div>

                    <!-- 5. Discount Setup (Desktop Column 5) -->
                    <div class="md:col-span-1 grid grid-cols-2 gap-3">
                        <!-- Discount Type Selector -->
                        <div class="col-span-1">
                            <select
                                data-id="${id}"
                                data-field="discountType"
                                class="input-field w-full bg-white text-sm"
                                onchange="handleInput(event)"
                            >
                                <option value="percentage" ${discountType === 'percentage' ? 'selected' : ''}>% Disc</option>
                                <option value="amount" ${discountType === 'amount' ? 'selected' : ''}>‚Çπ Amt</option>
                                <option value="final" ${discountType === 'final' ? 'selected' : ''}>Final ‚Çπ</option>
                            </select>
                        </div>

                        <!-- Discount Value Input -->
                        <div class="col-span-1">
                            <input
                                type="number"
                                min="0"
                                step="any"
                                value="${discountValue}"
                                data-id="${id}"
                                data-field="discountValue"
                                class="input-field w-full text-sm"
                                placeholder="${getPlaceholder(discountType)}"
                                oninput="handleInput(event)"
                                ${discountType === 'none' ? 'disabled' : ''}
                            />
                        </div>
                    </div>
                    
                    <!-- 6. Discount Amount (Desktop Column 6) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-red-600" id="discount-amount-display-desktop-${id}">
                            -‚Çπ${discountAmount.toFixed(2)}
                        </div>
                    </div>

                    <!-- 7. Discount Percentage (Desktop Column 7) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-red-600" id="discount-percent-display-desktop-${id}">
                            ${discountPercentage.toFixed(2)}%
                        </div>
                    </div>

                    <!-- 8. Product Final Price (Desktop Column 8) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output final text-green-600" id="final-price-display-desktop-${id}">
                            ‚Çπ${discountedPrice.toFixed(2)}
                        </div>
                    </div>

                    <!-- 9. Remove Button (Mobile/Desktop Column 9) -->
                    <div class="md:col-span-1 flex justify-end md:justify-center">
                        <button
                            data-id="${id}"
                            class="remove-product-btn text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150"
                            aria-label="Remove Product"
                            onclick="removeProduct(${id})"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>

                    <!-- Mobile-Only Discount Details (Hidden on Desktop) -->
                    <div class="mobile-only-details md:hidden space-y-2 border-t pt-2 mt-2">
                         <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Subtotal:</span>
                            <span class="text-indigo-500 font-semibold" id="subtotal-display-mobile-${id}">‚Çπ${subtotal.toFixed(2)}</span>
                        </div>
                        <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Discount Amount:</span>
                            <span id="discount-amount-display-mobile-${id}" class="font-semibold text-red-600">‚Çπ${discountAmount.toFixed(2)}</span>
                        </div>
                        <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Discount %:</span>
                            <span id="discount-percent-display-mobile-${id}" class="font-semibold text-red-600">${discountPercentage.toFixed(2)}%</span>
                        </div>
                        <!-- Displayed Final Price for Mobile-Only -->
                        <div class="text-lg font-bold text-green-600 flex justify-between pt-1 border-t border-gray-300">
                            <span class="text-gray-800">Product Final Price:</span>
                            <span id="final-price-display-${id}">‚Çπ${discountedPrice.toFixed(2)}</span>
                        </div>
                    </div>

                </div>
            `;
        }

        /**
         * Updates only the display elements for a specific product row.
         */
        function updateProductDisplay(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const format = (value) => value.toFixed(2);

            // --- MOBILE Updates ---
            const subtotalMobileEl = document.getElementById(`subtotal-display-mobile-${id}`);
            if (subtotalMobileEl) subtotalMobileEl.textContent = `‚Çπ${format(product.subtotal)}`;
            const discountAmountMobileEl = document.getElementById(`discount-amount-display-mobile-${id}`);
            if (discountAmountMobileEl) discountAmountMobileEl.textContent = `‚Çπ${format(product.discountAmount)}`;
            const discountPercentMobileEl = document.getElementById(`discount-percent-display-mobile-${id}`);
            if (discountPercentMobileEl) discountPercentMobileEl.textContent = `${format(product.discountPercentage)}%`;
            const finalPriceEl = document.getElementById(`final-price-display-${id}`);
            if (finalPriceEl) finalPriceEl.textContent = `‚Çπ${format(product.discountedPrice)}`;

            // --- DESKTOP Updates ---
            const subtotalDesktopEl = document.getElementById(`subtotal-display-desktop-${id}`);
            if (subtotalDesktopEl) subtotalDesktopEl.textContent = `‚Çπ${format(product.subtotal)}`;
            const discountAmountDesktopEl = document.getElementById(`discount-amount-display-desktop-${id}`);
            if (discountAmountDesktopEl) discountAmountDesktopEl.textContent = `-‚Çπ${format(product.discountAmount)}`;
            const discountPercentDesktopEl = document.getElementById(`discount-percent-display-desktop-${id}`);
            if (discountPercentDesktopEl) discountPercentDesktopEl.textContent = `${format(product.discountPercentage)}%`;
            const finalPriceDesktopEl = document.getElementById(`final-price-display-desktop-${id}`);
            if (finalPriceDesktopEl) finalPriceDesktopEl.textContent = `‚Çπ${format(product.discountedPrice)}`;
        }


        /**
         * Calculates the subtotal, discount, and final discounted price for a single product.
         */
        function calculateProductTotal(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            // 1. Calculate Subtotal
            product.unitPrice = parseFloat(product.unitPrice) || 0;
            product.units = parseInt(product.units) || 0;
            
            product.subtotal = product.unitPrice * product.units;
            let finalPrice = product.subtotal;
            product.discountAmount = 0;

            // 2. Apply Discount Logic
            const discValue = parseFloat(product.discountValue) || 0;
            const subtotal = product.subtotal;

            switch (product.discountType) {
                case 'percentage':
                    if (discValue > 0) {
                        const discount = (subtotal * (discValue / 100));
                        product.discountAmount = Math.min(discount, subtotal);
                        finalPrice = subtotal - product.discountAmount;
                    }
                    break;
                case 'amount':
                    product.discountAmount = Math.min(discValue, subtotal);
                    finalPrice = subtotal - product.discountAmount;
                    break;
                case 'final':
                    finalPrice = Math.max(0, Math.min(discValue, subtotal));
                    product.discountAmount = subtotal - finalPrice;
                    break;
            }

            product.discountedPrice = finalPrice;
            
            // 3. Calculate Effective Discount Percentage
            if (product.subtotal > 0) {
                product.discountPercentage = (product.discountAmount / product.subtotal) * 100;
            } else {
                product.discountPercentage = 0;
            }

            // Update display elements without re-rendering inputs
            updateProductDisplay(id); 
            updateGrandTotals();
        }

        /**
         * Calculates and updates the overall totals summary.
         */
        function updateGrandTotals() {
            let totalSubtotal = 0;
            let totalDiscount = 0;
            let grandTotal = 0;
            let totalDiscountPercentage = 0; 

            for (const product of products) {
                totalSubtotal += product.subtotal;
                totalDiscount += product.discountAmount;
                grandTotal += product.discountedPrice;
            }
            
            if (totalSubtotal > 0) {
                totalDiscountPercentage = (totalDiscount / totalSubtotal) * 100;
            }

            const format = (value) => `‚Çπ${value.toFixed(2)}`;
            const formatPercent = (value) => `${value.toFixed(2)}%`;

            totalSubtotalEl.textContent = format(totalSubtotal);
            totalDiscountEl.textContent = `-${format(totalDiscount)}`;
            totalDiscountPercentageEl.textContent = formatPercent(totalDiscountPercentage);
            grandTotalEl.textContent = format(grandTotal);

            return { totalSubtotal, totalDiscount, grandTotal, totalDiscountPercentage };
        }
        
        // --- Local Storage Functions ---

        /**
         * Retrieves all quote names from local storage and updates the datalist.
         */
        function updateDatalist() {
            savedQuotesDatalistEl.innerHTML = '';
            // Get all keys from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Filter keys to only include quote data (e.g., prefix them)
                if (key.startsWith('quote_')) {
                    const quoteName = key.substring(6); // Remove 'quote_' prefix
                    const option = document.createElement('option');
                    option.value = quoteName;
                    savedQuotesDatalistEl.appendChild(option);
                }
            }
            // Update delete button state
            updateDeleteButtonState(currentQuoteName);
        }

        /**
         * Saves the current product list to local storage under the currentQuoteName.
         */
        function saveQuoteLocally() {
            const quoteName = quoteNameInputEl.value.trim();
            if (!quoteName) {
                showMessage("Please enter a name for the price quote.", 'error');
                return;
            }

            try {
                // Prepare data for saving: only save essential product properties
                const dataToSave = products.map(p => ({
                    name: p.name,
                    unitPrice: p.unitPrice,
                    units: p.units,
                    discountType: p.discountType,
                    discountValue: p.discountValue,
                    // The rest (subtotal, finalPrice) are calculated on load
                }));

                localStorage.setItem(`quote_${quoteName}`, JSON.stringify(dataToSave));
                
                currentQuoteName = quoteName;
                updateDatalist();
                updateDeleteButtonState(quoteName);
                showMessage(`Quote "${quoteName}" saved successfully!`, 'success');

            } catch (e) {
                showMessage("Could not save quote. Local storage might be full or unavailable.", 'error');
                console.error("Local storage error:", e);
            }
        }

        /**
         * Loads a quote from local storage and replaces the current product list.
         */
        function loadQuoteLocally(quoteName) {
            const data = localStorage.getItem(`quote_${quoteName}`);
            if (!data) return false;

            try {
                const loadedProducts = JSON.parse(data);
                products = [];
                nextProductId = 1; // Reset product IDs

                // Map loaded data back into the full product structure
                loadedProducts.forEach(p => {
                    const newProduct = {
                        id: nextProductId++,
                        ...p,
                        subtotal: 0,
                        discountAmount: 0,
                        discountPercentage: 0,
                        discountedPrice: 0,
                    };
                    products.push(newProduct);
                    // Recalculate totals for the new products
                    calculateProductTotal(newProduct.id); 
                });
                
                updateUI();
                showMessage(`Quote "${quoteName}" loaded successfully!`, 'info');
                return true;

            } catch (e) {
                showMessage("Error loading quote. Data may be corrupted.", 'error');
                console.error("Local storage parse error:", e);
                return false;
            }
        }

        /**
         * Deletes a quote from local storage.
         */
        function deleteQuoteLocally() {
            const quoteName = quoteNameInputEl.value.trim();
            if (!quoteName) return;

            try {
                if (localStorage.getItem(`quote_${quoteName}`)) {
                    localStorage.removeItem(`quote_${quoteName}`);
                    
                    showMessage(`Quote "${quoteName}" deleted.`, 'success');
                    
                    // Clear the current display
                    products = [];
                    addProduct(true); // Start a new default product with 0 price
                    quoteNameInputEl.value = '';
                    currentQuoteName = '';
                    updateDatalist();
                    updateDeleteButtonState('');

                } else {
                    showMessage(`Quote "${quoteName}" not found.`, 'error');
                }
            } catch (e) {
                showMessage("Could not delete quote due to storage error.", 'error');
                console.error("Local storage error:", e);
            }
        }

        /**
         * Resets the current quote, clearing the product list and input field.
         */
        function clearQuote() {
            products = [];
            quoteNameInputEl.value = '';
            currentQuoteName = '';
            updateDeleteButtonState('');
            showMessage("Quote cleared. Ready for a new quote!", 'info');
            addProduct(true); // Add a default product starting with 0 price
        }
        
        /**
         * Handles input/change on the quote name field for loading and enabling deletion.
         */
        function handleQuoteNameChange(name) {
            const trimmedName = name.trim();
            currentQuoteName = trimmedName;

            const isSaved = localStorage.getItem(`quote_${trimmedName}`) !== null;
            
            // If the user selects a saved quote or finishes typing a saved quote name, load it.
            if (isSaved) {
                loadQuoteLocally(trimmedName);
            } 
            
            updateDeleteButtonState(trimmedName);
        }

        /**
         * Toggles the delete button state based on whether the quote name exists locally.
         */
        function updateDeleteButtonState(name) {
            const isSaved = localStorage.getItem(`quote_${name}`) !== null && name.length > 0;
            deleteQuoteBtnEl.disabled = !isSaved;
            deleteQuoteBtnEl.classList.toggle('opacity-50', !isSaved);
            deleteQuoteBtnEl.classList.toggle('hover:bg-red-600', isSaved);
        }

        // --- Core UI Functions ---

        /**
         * Re-renders the entire product list (ONLY used on ADD or REMOVE product or discount type change).
         */
        function updateUI() {
            productListEl.innerHTML = products.map(renderProductRow).join('');
            
            // Ensure recalculation runs for all products
            products.forEach(p => calculateProductTotal(p.id)); 
            
            updateGrandTotals();
        }

        /**
         * Centralized handler for all product input changes.
         */
        function handleInput(event) {
            const input = event.target;
            const id = parseInt(input.dataset.id);
            const field = input.dataset.field;
            const product = products.find(p => p.id === id);

            if (!product) return;

            let value = input.value;

            if (field === 'name') {
                product[field] = value;
            } else if (field === 'discountType') {
                product.discountValue = 0;
                product.discountType = value;
                // Re-render the row to update the discount value placeholder
                updateUI();
                return; 
            } else {
                product[field] = parseFloat(value) || 0;
            }

            calculateProductTotal(id);
        }

        /**
         * Adds a new product row to the list.
         * @param {boolean} [startEmpty=false] - If true, sets unit price and discount to 0.
         */
        function addProduct(startEmpty = false) {
            const initialPrice = startEmpty ? 0.00 : 1000.00;
            const initialDiscount = startEmpty ? 0 : 0;
            
            const newProduct = {
                id: nextProductId++,
                name: `Product ${nextProductId-1}`,
                unitPrice: initialPrice,
                units: 1,
                discountType: 'percentage',
                discountValue: initialDiscount,
                subtotal: 0,
                discountAmount: 0,
                discountPercentage: 0,
                discountedPrice: 0,
            };
            products.push(newProduct);
            calculateProductTotal(newProduct.id);
            updateUI();
            
            // Focus logic needs a slight delay to ensure the element exists after DOM update
            setTimeout(() => {
                const newProductEl = document.getElementById(`product-${newProduct.id}`);
                if (newProductEl) {
                    newProductEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Focus on the Unit Price field
                    const unitPriceInput = newProductEl.querySelector(`[data-field="unitPrice"]`);
                    if (unitPriceInput) {
                        unitPriceInput.focus();
                        unitPriceInput.select(); 
                    }
                }
            }, 0);
        }

        /**
         * Removes a product row from the list.
         */
        function removeProduct(id) {
            products = products.filter(p => p.id !== id);
            // If all products are deleted, start a new blank one
            if (products.length === 0) {
                addProduct(true);
            } else {
                updateUI();
            }
        }

        // --- Copy/Share Functions (Unchanged) ---
        
        function generateWhatsappSummaryText() {
            const totals = updateGrandTotals(); 
            const productDetails = products.map((product, index) => {
                const formatPrice = (value) => value.toFixed(2);
                const formatPercent = (value) => value.toFixed(2);

                return `
${index + 1}. *${product.name || 'Untitled Product'}*
    Unit Price: ‚Çπ${formatPrice(product.unitPrice)}
    Units: ${product.units}
    Subtotal: ‚Çπ${formatPrice(product.subtotal)}
    _Discount Applied:_
    Amount: *-‚Çπ${formatPrice(product.discountAmount)}*
    Percentage: *${formatPercent(product.discountPercentage)}%*
    *Product Final Price: ‚Çπ${formatPrice(product.discountedPrice)}*`; 
            }).join('\n');

            const summary = `
*üí∞ PRICE QUOTE SUMMARY*
_Prepared using Discount Calculator Pro_

*--- PRODUCT DETAILS ---*
${productDetails}

*--- GRAND TOTAL ---*

Total Subtotal: *‚Çπ${totals.totalSubtotal.toFixed(2)}*
Total Savings: *-‚Çπ${totals.totalDiscount.toFixed(2)}*
*Overall Discount: ${totals.totalDiscountPercentage.toFixed(2)}%*
*NET PAYABLE AMOUNT: ‚Çπ${totals.grandTotal.toFixed(2)}*`;
            return summary.trim();
        }

        function generatePlainTextQuote() {
            const totals = updateGrandTotals(); 
            const productDetails = products.map((product, index) => {
                const formatPrice = (value) => value.toFixed(2);
                const formatPercent = (value) => value.toFixed(2);

                return `
${index + 1}. ${product.name || 'Untitled Product'}
    Unit Price: ‚Çπ${formatPrice(product.unitPrice)}
    Units: ${product.units}
    Subtotal: ‚Çπ${formatPrice(product.subtotal)}
    Discount Applied:
    Amount: -‚Çπ${formatPrice(product.discountAmount)}
    Percentage: ${formatPercent(product.discountPercentage)}%
    Product Final Price: ‚Çπ${formatPrice(product.discountedPrice)}`; 
            }).join('\n');

            const summary = `
PRICE QUOTE SUMMARY
Prepared using Discount Calculator Pro

--- PRODUCT DETAILS ---
${productDetails}

--- GRAND TOTAL ---

Total Subtotal: ‚Çπ${totals.totalSubtotal.toFixed(2)}
Total Savings: -‚Çπ${totals.totalDiscount.toFixed(2)}
Overall Discount: ${totals.totalDiscountPercentage.toFixed(2)}%
NET PAYABLE AMOUNT: ‚Çπ${totals.grandTotal.toFixed(2)}`;
            return summary.trim();
        }

        function shareToWhatsapp() {
            const encodedText = encodeURIComponent(generateWhatsappSummaryText());
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            window.open(whatsappUrl, '_blank');
        }

        function copyToClipboard() {
            const summaryText = generatePlainTextQuote();
            const copyButton = document.getElementById('copy-quote-btn');

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = summaryText;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.top = '0';
            tempTextArea.style.left = '0';
            tempTextArea.style.opacity = '0';
            
            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();

            let successful = false;
            try {
                successful = document.execCommand('copy');
            } catch (err) {
                console.error('Copy command failed:', err);
            }
            document.body.removeChild(tempTextArea);
            
            if (successful) {
                const originalContent = copyButton.innerHTML;
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> <span>Copied!</span>`;
                copyButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                copyButton.classList.add('bg-blue-500', 'hover:bg-blue-600'); 

                setTimeout(() => {
                    copyButton.innerHTML = originalContent;
                    copyButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    copyButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                }, 2000);
            } else {
                showMessage('Failed to copy text automatically.', 'error');
            }
        }


        // --- Initialization ---
        window.onload = function() {
            updateDatalist(); // Load available quote names
            if (products.length === 0) {
                 addProduct(true); // Add a default product starting with 0 price if nothing is present
            }
        }
    </script>
</body>
</html>
