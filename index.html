<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- STRICTLY MAINTAINED TITLE -->
    <title>Discount Calculator Pro</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for aesthetics and mobile feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.3s;
        }
        .input-field {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }
        /* Custom class for validation error */
        .input-error {
            border-color: #ef4444 !important; /* Red-500 */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

        /* Desktop-specific styles for product row to enable tabular view */
        @media (min-width: 768px) {
            .product-row-desktop-grid {
                /* 11 Columns: Drag, Number, Name, Price, Units, Subtotal, Discount Setup, Discount Amt, Discount %, Final Price, Remove Btn */
                grid-template-columns: 0.3fr 0.4fr 1.5fr 1fr 0.7fr 1fr 2fr 1fr 0.8fr 1.2fr auto; 
                display: grid;
                align-items: center;
                gap: 1rem;
                padding: 1rem 0.5rem; /* Reduced padding to fit more content */
            }
            .product-row .mobile-only-details {
                display: none; /* Hide stacked details on desktop */
            }
            /* Style for the calculated outputs */
            .calculated-output {
                font-size: 0.9rem;
                font-weight: 600;
                text-align: right;
                padding-right: 4px;
            }
            .calculated-output.final {
                font-size: 1rem;
                font-weight: 800;
            }
            
            /* Enhanced desktop hover for product row */
            .product-row-desktop-grid:hover {
                 background-color: #f3f4f6;
            }
        }
        
        /* Drag and Drop Feedback */
        .dragging {
            opacity: 0.4;
            border-radius: 0.75rem;
            border: 2px dashed #6366f1; /* Indigo-500 */
        }
        .drag-over {
            border-color: #10b981 !important; /* Emerald-500 */
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        /* Mobile specific styles for action buttons */
        .mobile-action-button {
             font-size: 0.95rem;
        }
        
        /* Modal specific styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Controlled by JS */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        .modal.open {
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto"> 
        <header class="text-center mb-8">
            <!-- H1 -->
            <h1 class="text-4xl font-extrabold text-gray-900">Discount Calculator Pro</h1>
            <!-- SUBTITLE (FIXED) -->
            <p class="text-gray-500 mt-1">Quickly Generate Error-Free Quotes with Advanced Discount and Tax Control.</p>
        </header>

        <main class="bg-white p-6 rounded-2xl container-card space-y-8 mb-6">
            
            <!-- Quote Management & Memo Section -->
            <div class="border-b pb-4 mb-4 space-y-3">
                <h2 class="text-xl font-bold text-gray-700">Quote Management</h2>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <!-- Quote Name Input -->
                    <div class="sm:flex-grow">
                        <input
                            type="text"
                            id="quote-name-input"
                            placeholder="Enter Name for this Quote"
                            class="input-field w-full text-base font-medium"
                            oninput="setCurrentQuoteName(this.value)"
                        />
                    </div>

                    <!-- Action Buttons -->
                    <button id="save-quote-btn" onclick="saveQuoteToLocalStorage()" class="mobile-action-button w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        <span id="save-text">ðŸ’¾ Save Quote</span>
                    </button>
                    <button id="clear-quote-btn" onclick="clearQuote()" class="mobile-action-button w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        âœ¨ Clear Quote
                    </button>
                    <!-- History Modal Button -->
                    <button id="open-history-btn" onclick="openHistoryModal()" class="mobile-action-button w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 shadow-md flex-shrink-0">
                        ðŸ“š Quote History
                    </button>
                </div>
                
                <!-- Quote Memo Input -->
                <div class="mt-4">
                    <label for="quote-memo-input" class="block text-sm font-medium text-gray-700 mb-1">
                        Optional Quote Memo/Notes
                    </label>
                    <textarea
                        id="quote-memo-input"
                        placeholder="Add notes, client details, or special conditions..."
                        class="input-field w-full h-20 resize-y text-sm"
                        oninput="setCurrentMemo(this.value)"
                    ></textarea>
                </div>
            </div>

            <!-- Global Settings (Tax & Currency) -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <!-- Currency Selector -->
                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
                    <label for="currency-select" class="block text-base font-bold text-gray-700 mb-2 text-center">
                        Select Currency Symbol
                    </label>
                    <select
                        id="currency-select"
                        class="input-field w-full text-xl font-bold text-center bg-white"
                        onchange="setCurrentCurrency(this.value)"
                    >
                        <option value="â‚¹">â‚¹ - Indian Rupee</option>
                        <option value="$">$ - US Dollar</option>
                        <option value="â‚¬">â‚¬ - Euro</option>
                        <option value="Â£">Â£ - British Pound</option>
                        <option value="Â¥">Â¥ - Japanese Yen</option>
                    </select>
                </div>
                
                <!-- Global Tax Input -->
                <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200 shadow-inner">
                    <label for="global-tax-input" class="block text-base font-bold text-gray-700 mb-2 text-center">
                        Global Sales Tax / GST (%)
                    </label>
                    <div class="flex items-center space-x-2">
                        <input
                            type="number"
                            min="0"
                            step="0.1"
                            id="global-tax-input"
                            value="0"
                            class="input-field w-full text-xl font-bold text-center bg-white"
                            oninput="handleGlobalTaxInput(event)"
                        />
                        <span class="text-2xl font-extrabold text-gray-600">%</span>
                    </div>
                </div>
            </div>

            <!-- Product List Header (Desktop Only - 11 Columns) -->
            <div class="hidden md:grid md:grid-cols-[0.3fr_0.4fr_1.5fr_1fr_0.7fr_1fr_2fr_1fr_0.8fr_1.2fr_auto] gap-4 mb-2 p-3 border-b border-gray-300 font-extrabold text-gray-700 text-sm bg-gray-100 rounded-t-lg">
                <span class="w-6"></span> <!-- Drag Handle Spacer -->
                <span>#</span>
                <span>Product Name</span>
                <span id="header-unit-price">Unit Price</span>
                <span>Units</span>
                <span class="text-right" id="header-subtotal">Subtotal</span>
                <span class="text-center">Discount Setup</span>
                <span class="text-right" id="header-disc-amt">Discount Amt</span>
                <span class="text-right">Disc. %</span>
                <span class="text-right" id="header-final-price">Final Price</span>
                <span class="w-6"></span> <!-- Spacer for delete button -->
            </div>

            <!-- Product List Area -->
            <div id="product-list" class="space-y-4">
                <h2 class="text-xl font-bold border-b pb-2 text-gray-800 md:hidden">Products (Drag to Reorder)</h2>
                <!-- Product rows will be inserted here -->
            </div>

            <!-- Action Button: Add Product -->
            <button id="add-product-btn" onclick="addProduct()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg">
                + Add New Product
            </button>
            
            <!-- Totals Summary Area -->
            <div id="totals-summary" class="mt-8 pt-4 pb-4 md:pt-6 md:px-0 md:pb-6">
                <h2 class="text-xl font-extrabold mb-3 text-gray-800 text-center md:text-left">Quote Totals Summary</h2>
                
                <div class="space-y-3 p-4 bg-gray-50 rounded-xl border border-gray-200 shadow-inner max-w-lg mx-auto md:max-w-none"> 
                    
                    <div class="flex justify-between text-base">
                        <span class="text-gray-600 font-medium">Total Subtotal:</span>
                        <span id="total-subtotal" class="font-bold text-gray-800">â‚¹0.00</span>
                    </div>
                    
                    <div class="flex justify-between text-base">
                        <span class="text-gray-600 font-medium">Total Discount/Savings:</span>
                        <span id="total-discount" class="font-bold text-red-500">-â‚¹0.00</span>
                    </div>

                    <div class="flex justify-between text-lg pt-2 border-t border-gray-300">
                        <span class="text-gray-700 font-semibold">Net Amount (Before Tax):</span>
                        <span id="net-payable-amount" class="font-extrabold text-indigo-600">â‚¹0.00</span>
                    </div>

                    <div class="flex justify-between text-base">
                        <span class="text-gray-600" id="tax-label">Tax (0.0%):</span>
                        <span id="tax-amount" class="font-bold text-gray-800">â‚¹0.00</span>
                    </div>

                    <div class="flex justify-between text-2xl font-extrabold pt-3 border-t-4 border-indigo-600/30">
                        <span class="text-gray-900">Grand Total:</span>
                        <span id="grand-total" class="text-green-600">â‚¹0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Standard Action Buttons -->
             <div class="flex flex-col sm:flex-row gap-4 pt-4 border-t border-gray-200 mt-8">
                <!-- WhatsApp Share Button -->
                <button id="share-whatsapp-btn" onclick="shareToWhatsapp()" class="w-full sm:w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg flex items-center justify-center space-x-2 mobile-action-button">
                    <!-- WhatsApp Icon (inline SVG for portability) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-white">
                        <path d="M12.03 2.01c-5.5 0-9.98 4.48-9.98 9.98 0 1.94.57 3.82 1.63 5.42l-1.63 5.96 6.13-1.6c1.55.84 3.32 1.28 5.12 1.28 5.5 0 9.98-4.48 9.98-9.98s-4.48-9.98-9.98-9.98zm4.73 13.92c-.22.56-.99.93-1.42 1.05-.4.11-.84.17-1.29.17-1.35 0-2.65-.5-3.64-1.32-.98-.82-1.74-2.13-1.74-3.48 0-.91.24-1.66.7-2.31.47-.64 1.15-1.07 1.94-1.25.79-.18 1.63-.08 2.37.52.75.6 1.17 1.48 1.17 2.44 0 .22-.04.42-.1.62-.07.2-.18.39-.34.56-.16.17-.35.3-.56.4-.2.11-.42.17-.65.17-.03 0-.05 0-.08 0l-.13-.02c-.52-.08-1.03-.3-1.5-.66-.47-.36-.88-.84-1.23-1.44-.06-.11-.11-.23-.15-.36-.04-.13-.05-.26-.05-.4 0-.32.13-.62.36-.85.23-.23.53-.36.85-.36.24 0 .47.05.69.15.22.1.42.25.58.44.17.2.26.43.26.69 0 .16-.03.32-.08.47-.05.15-.12.29-.2.43-.19.3-.43.56-.7.77l-.02.02c.48.37 1.03.66 1.62.86.6.2 1.24.29 1.9.29.13 0 .26-.01.39-.03.74-.12 1.34-.5 1.8-1.14.47-.64.7-1.4.7-2.28 0-.82-.26-1.5-.77-2.04-.51-.55-1.22-.84-2.12-.84h-1.5c-.32 0-.62-.13-.85-.36-.23-.23.53-.36.85-.36 0-.32.13-.62.36-.85.23-.23.53-.36.85-.36h1.5c.9 0 1.76.27 2.47.81.71.54 1.1 1.25 1.1 2.08 0 .5-.08.98-.24 1.44-.16.46-.37.88-.63 1.26z"/>
                    </svg>
                    <span>Share via WhatsApp</span>
                </button>

                <!-- Copy Text Button -->
                <button id="copy-quote-btn" onclick="copyToClipboard()" class="w-full sm:w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg flex items-center justify-center space-x-2 mobile-action-button">
                    <!-- Copy Icon (inline SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zm4 0v4a1 1 0 01-1 1H9a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zm4 0v4a1 1 0 01-1 1h-3a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 011 1zM7 16h10" />
                    </svg>
                    <span>Copy Price Quote</span>
                </button>
            </div>


        </main>
        

    </div>

    <!-- Custom message box for UI feedback -->
    <div id="message-box" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 p-3 bg-blue-600 text-white rounded-lg shadow-xl hidden z-50 transition-opacity duration-300"></div>


    <!-- Quote History Modal (LocalStorage) -->
    <div id="history-modal" class="modal">
        <div class="modal-content w-full sm:max-w-xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold text-gray-800">ðŸ“š Quote History (Local)</h3>
                <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <input type="text" id="history-search-input" oninput="renderHistoryList()" placeholder="Search quotes by name..." class="input-field w-full mb-4">

            <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Quote list will be rendered here -->
            </div>
            
            <p id="history-empty-state" class="text-center text-gray-500 mt-4 hidden">No saved quotes found.</p>
        </div>
    </div>


    <script>
        // Global variables
        let products = [];
        let globalTaxRate = 0; 
        let currentQuoteName = '';
        let currentQuoteId = null; // Used to identify if the current quote is a loaded one
        let currentCurrency = 'â‚¹'; // New: Default currency symbol
        let currentMemo = ''; // New: Optional quote memo
        
        // LocalStorage Key
        const QUOTE_HISTORY_KEY = 'discountCalculatorQuotes';

        // DOM Elements
        const productListEl = document.getElementById('product-list');
        const totalSubtotalEl = document.getElementById('total-subtotal');
        const totalDiscountEl = document.getElementById('total-discount');
        const netPayableEl = document.getElementById('net-payable-amount');
        const taxAmountEl = document.getElementById('tax-amount');
        const taxLabelEl = document.getElementById('tax-label');
        const grandTotalEl = document.getElementById('grand-total');
        const globalTaxInputEl = document.getElementById('global-tax-input');
        const quoteNameInputEl = document.getElementById('quote-name-input');
        const quoteMemoInputEl = document.getElementById('quote-memo-input'); // New Memo Input
        const currencySelectEl = document.getElementById('currency-select'); // New Currency Select
        const messageBoxEl = document.getElementById('message-box');
        const historyModalEl = document.getElementById('history-modal');
        const historySearchInputEl = document.getElementById('history-search-input');
        const historyEmptyStateEl = document.getElementById('history-empty-state');
        const saveTextEl = document.getElementById('save-text');
        const historyListEl = document.getElementById('history-list');
        
        // Header elements that need currency update
        const headerElements = [
            'header-unit-price', 'header-subtotal', 'header-disc-amt', 'header-final-price'
        ];


        // --- Utility Functions ---

        function showMessage(message, type = 'success') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-yellow-600'
            };
            
            messageBoxEl.textContent = message;
            messageBoxEl.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-lg shadow-xl z-50 transition-opacity duration-300`;
            // Remove old colors, add new, and show
            messageBoxEl.classList.remove('hidden', 'bg-green-600', 'bg-red-600', 'bg-blue-600', 'bg-yellow-600');
            messageBoxEl.classList.add(colors[type]);
            messageBoxEl.classList.remove('hidden');
            messageBoxEl.style.opacity = '1';

            setTimeout(() => {
                messageBoxEl.style.opacity = '0';
                setTimeout(() => {
                    messageBoxEl.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // New: Currency formatting function
        function formatCurrency(value) {
            return `${currentCurrency}${value.toFixed(2)}`;
        }

        function getPlaceholder(type) {
            switch (type) {
                case 'percentage': return 'Discount % (e.g., 10)';
                case 'amount': return `Discount Amount (${currentCurrency})`;
                case 'final': return `Discounted Final Price (${currentCurrency})`;
                default: return 'Enter value';
            }
        }
        
        // --- Core Calculator Logic ---
        
        function renderProductRow(product, index) { 
            const { id, name, unitPrice, units, discountType, discountValue, subtotal, discountedPrice, discountAmount, discountPercentage, isValid } = product;
            const format = formatCurrency;
            const errorClass = isValid === false ? 'input-error' : '';
            const productNumber = index + 1; 

            return `
                <!-- Responsive & Draggable Product Row Container -->
                <div id="product-${id}" 
                     draggable="true" 
                     ondragstart="handleDragStart(event)"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event)"
                     ondragleave="handleDragLeave(event)"
                     ondragend="handleDragEnd(event)"
                     data-id="${id}"
                     class="product-row bg-white border border-gray-200 rounded-xl shadow-md space-y-3 p-4 md:p-0 md:border-0 md:shadow-none md:space-y-0 md:border-t md:first:border-t-0 product-row-desktop-grid cursor-move">
                    
                    <!-- Drag Handle (Desktop Column 1 / Mobile First Element) -->
                    <div class="md:col-span-1 flex items-center justify-center text-gray-400 hover:text-gray-700 w-full h-full md:block">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </div>

                    <!-- Product Number (#) (Desktop Column 2) -->
                    <div class="hidden md:block md:col-span-1 text-center font-extrabold text-lg text-indigo-600">
                        ${productNumber}.
                    </div>

                    <!-- 1. Product Name (Desktop Column 3) -->
                    <div class="md:col-span-1">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Product Name</span>
                            <input
                                type="text"
                                placeholder="Product Name (e.g., Laptop)"
                                value="${name}"
                                data-id="${id}"
                                data-field="name"
                                class="input-field text-lg font-semibold w-full"
                                oninput="handleInput(event)"
                                onclick="handleDragClick(event)"
                            />
                        </label>
                    </div>

                    <!-- 2. Unit Price (Desktop Column 4) -->
                    <div class="md:col-span-1 md:block">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Unit Price (${currentCurrency})</span>
                            <input
                                type="number"
                                min="0"
                                step="0.01"
                                value="${unitPrice}"
                                data-id="${id}"
                                data-field="unitPrice"
                                class="input-field w-full product-unit-price-${id} ${errorClass}"
                                oninput="handleInput(event)"
                                onclick="handleDragClick(event)"
                            />
                        </label>
                    </div>

                    <!-- 3. Units (Desktop Column 5) -->
                    <div class="md:col-span-1 md:block">
                        <label class="block">
                            <span class="text-xs font-medium text-gray-500 md:hidden">Units</span>
                            <input
                                type="number"
                                min="1"
                                step="1"
                                value="${units}"
                                data-id="${id}"
                                data-field="units"
                                class="input-field w-full ${errorClass}"
                                oninput="handleInput(event)"
                                onclick="handleDragClick(event)"
                            />
                        </label>
                    </div>
                    
                    <!-- 4. Subtotal (Desktop Column 6) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-gray-700 font-bold" id="subtotal-display-desktop-${id}">
                            ${format(subtotal)}
                        </div>
                    </div>

                    <!-- 5. Discount Setup (Desktop Column 7) -->
                    <div class="md:col-span-1 grid grid-cols-2 gap-3">
                        <!-- Discount Type Selector -->
                        <div class="col-span-1">
                            <select
                                data-id="${id}"
                                data-field="discountType"
                                class="input-field w-full bg-white text-sm"
                                onchange="handleInput(event)"
                                onclick="handleDragClick(event)"
                            >
                                <option value="percentage" ${discountType === 'percentage' ? 'selected' : ''}>% Disc</option>
                                <option value="amount" ${discountType === 'amount' ? 'selected' : ''}>${currentCurrency} Amt</option>
                                <option value="final" ${discountType === 'final' ? 'selected' : ''}>Final ${currentCurrency}</option>
                            </select>
                        </div>

                        <!-- Discount Value Input -->
                        <div class="col-span-1">
                            <input
                                type="number"
                                min="0"
                                step="any"
                                value="${discountValue}"
                                data-id="${id}"
                                data-field="discountValue"
                                class="input-field w-full text-sm ${discountType !== 'final' && errorClass}"
                                placeholder="${getPlaceholder(discountType)}"
                                oninput="handleInput(event)"
                                onclick="handleDragClick(event)"
                                ${discountType === 'none' ? 'disabled' : ''}
                            />
                        </div>
                    </div>
                    
                    <!-- 6. Discount Amount (Desktop Column 8) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-red-600" id="discount-amount-display-desktop-${id}">
                            -${format(discountAmount)}
                        </div>
                    </div>

                    <!-- 7. Discount Percentage (Desktop Column 9) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output text-red-600" id="discount-percent-display-desktop-${id}">
                            ${discountPercentage.toFixed(2)}%
                        </div>
                    </div>

                    <!-- 8. Product Final Price (Desktop Column 10) -->
                    <div class="hidden md:block md:col-span-1">
                        <div class="calculated-output final text-green-600" id="final-price-display-desktop-${id}">
                            ${format(discountedPrice)}
                        </div>
                    </div>

                    <!-- 9. Remove Button (Mobile/Desktop Column 11) -->
                    <div class="md:col-span-1 flex justify-end md:justify-center">
                        <button
                            data-id="${id}"
                            class="remove-product-btn text-red-500 hover:text-red-700 p-2 rounded-full transition duration-150 hover:bg-red-50"
                            aria-label="Remove Product"
                            onclick="removeProduct('${id}')"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>

                    <!-- Mobile-Only Discount Details (Hidden on Desktop) -->
                    <div class="mobile-only-details md:hidden space-y-2 border-t pt-2 mt-2">
                         <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Subtotal:</span>
                            <span class="text-indigo-500 font-semibold" id="subtotal-display-mobile-${id}">${format(subtotal)}</span>
                        </div>
                        <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Discount Amount:</span>
                            <span id="discount-amount-display-mobile-${id}" class="font-semibold text-red-600">-${format(discountAmount)}</span>
                        </div>
                        <div class="text-sm text-gray-600 flex justify-between">
                            <span class="font-medium">Discount %:</span>
                            <span id="discount-percent-display-mobile-${id}" class="font-semibold text-red-600">${discountPercentage.toFixed(2)}%</span>
                        </div>
                        <!-- Displayed Final Price for Mobile-Only -->
                        <div class="text-lg font-bold text-green-600 flex justify-between pt-1 border-t border-gray-300 mt-2">
                            <span class="text-gray-800">Product Final Price:</span>
                            <span id="final-price-display-${id}">${format(discountedPrice)}</span>
                        </div>
                    </div>

                </div>
            `;
        }

        function updateProductDisplay(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const format = formatCurrency;

            // --- MOBILE Updates ---
            const subtotalMobileEl = document.getElementById(`subtotal-display-mobile-${id}`);
            if (subtotalMobileEl) subtotalMobileEl.textContent = format(product.subtotal);
            const discountAmountMobileEl = document.getElementById(`discount-amount-display-mobile-${id}`);
            if (discountAmountMobileEl) discountAmountMobileEl.textContent = `-${format(product.discountAmount)}`;
            const discountPercentMobileEl = document.getElementById(`discount-percent-display-mobile-${id}`);
            if (discountPercentMobileEl) discountPercentMobileEl.textContent = `${product.discountPercentage.toFixed(2)}%`;
            const finalPriceEl = document.getElementById(`final-price-display-${id}`);
            if (finalPriceEl) finalPriceEl.textContent = format(product.discountedPrice);

            // --- DESKTOP Updates ---
            const subtotalDesktopEl = document.getElementById(`subtotal-display-desktop-${id}`);
            if (subtotalDesktopEl) subtotalDesktopEl.textContent = format(product.subtotal);
            const discountAmountDesktopEl = document.getElementById(`discount-amount-display-desktop-${id}`);
            if (discountAmountDesktopEl) discountAmountDesktopEl.textContent = `-${format(product.discountAmount)}`;
            const discountPercentDesktopEl = document.getElementById(`discount-percent-display-desktop-${id}`);
            if (discountPercentDesktopEl) discountPercentDesktopEl.textContent = `${product.discountPercentage.toFixed(2)}%`;
            const finalPriceDesktopEl = document.getElementById(`final-price-display-desktop-${id}`);
            if (finalPriceDesktopEl) finalPriceDesktopEl.textContent = format(product.discountedPrice);
        }


        function calculateProductTotal(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            product.subtotal = product.unitPrice * product.units;
            let finalPrice = product.subtotal;
            product.discountAmount = 0;

            const discValue = product.discountValue;
            const subtotal = product.subtotal;

            switch (product.discountType) {
                case 'percentage':
                    if (discValue > 0) {
                        const discount = (subtotal * (discValue / 100));
                        product.discountAmount = Math.min(discount, subtotal);
                        finalPrice = subtotal - product.discountAmount;
                    }
                    break;
                case 'amount':
                    product.discountAmount = Math.min(discValue, subtotal);
                    finalPrice = subtotal - product.discountAmount;
                    break;
                case 'final':
                    finalPrice = Math.max(0, Math.min(discValue, subtotal));
                    product.discountAmount = subtotal - finalPrice;
                    break;
            }

            product.discountedPrice = finalPrice;
            
            if (product.subtotal > 0) {
                product.discountPercentage = (product.discountAmount / product.subtotal) * 100;
            } else {
                product.discountPercentage = 0;
            }

            updateProductDisplay(id); 
            // We do NOT call updateGrandTotals here to avoid multiple calls during bulk updates.
            // It will be called by updateUI or explicitly before sharing.
        }

        // FIX: Function to force recalculation of all product totals
        function recalculateAllProducts() {
            // This ensures the 'products' array state is fully up-to-date
            // with all derived values (subtotal, discountAmount, discountedPrice).
            products.forEach(p => calculateProductTotal(p.id));
        }

        function updateGrandTotals() {
            let totalSubtotal = 0;
            let totalDiscount = 0;
            let netPayableAmount = 0;

            for (const product of products) {
                totalSubtotal += product.subtotal;
                totalDiscount += product.discountAmount;
                netPayableAmount += product.discountedPrice;
            }
            
            const taxRate = globalTaxRate / 100;
            const taxAmount = netPayableAmount * taxRate;
            const grandTotal = netPayableAmount + taxAmount;


            const format = formatCurrency;

            totalSubtotalEl.textContent = format(totalSubtotal);
            totalDiscountEl.textContent = `-${format(totalDiscount)}`;
            netPayableEl.textContent = format(netPayableAmount);
            taxAmountEl.textContent = format(taxAmount);
            taxLabelEl.textContent = `Tax (${globalTaxRate.toFixed(1)}%):`;
            grandTotalEl.textContent = format(grandTotal);

            return { 
                totalSubtotal, 
                totalDiscount, 
                netPayableAmount, 
                taxAmount, 
                grandTotal, 
                globalTaxRate
            };
        }

        function handleGlobalTaxInput(event) {
            let value = parseFloat(event.target.value) || 0;
            
            if (value < 0) {
                value = 0;
                event.target.value = 0;
                showMessage("Tax rate cannot be negative.", 'warning');
            }
            if (value > 100) {
                value = 100;
                event.target.value = 100;
                showMessage("Tax rate capped at 100%.", 'warning');
            }

            globalTaxRate = value;
            updateGrandTotals();
            localStorage.setItem('globalTaxRate', globalTaxRate); // Save preference locally
        }
        
        // New: Function to handle currency change
        function setCurrentCurrency(symbol) {
            currentCurrency = symbol;
            localStorage.setItem('currentCurrency', currentCurrency);
            updateUI(); // Re-render to update all symbols and placeholders
            updateHeaderCurrencyLabels();
        }
        
        // New: Update currency labels in desktop product list header
        function updateHeaderCurrencyLabels() {
            headerElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = el.textContent.split(' ')[0] + ` (${currentCurrency})`;
                }
            });
            // Also update the placeholders in the dynamic discount options on all existing products
            products.forEach(p => {
                 const selectEl = productListEl.querySelector(`#product-${p.id} select[data-field="discountType"]`);
                 if (selectEl) {
                    // Update discount type options
                    const amtOption = selectEl.querySelector(`option[value="amount"]`);
                    const finalOption = selectEl.querySelector(`option[value="final"]`);
                    if (amtOption) amtOption.textContent = `${currentCurrency} Amt`;
                    if (finalOption) finalOption.textContent = `Final ${currentCurrency}`;
                    
                    // Update discount value placeholder
                    const valueInput = productListEl.querySelector(`#product-${p.id} input[data-field="discountValue"]`);
                    if (valueInput) {
                        valueInput.placeholder = getPlaceholder(p.discountType);
                    }
                 }
            });
        }
        
        // New: Function to handle memo input
        function setCurrentMemo(memo) {
            currentMemo = memo;
        }


        function updateUI() {
            productListEl.innerHTML = products.map(renderProductRow).join('');
            recalculateAllProducts(); // CRITICAL: Ensure products state is calculated after rendering, before summing totals
            updateGrandTotals();
            updateHeaderCurrencyLabels();
            
            // Update save button text based on whether a saved quote is loaded
            if (currentQuoteId) {
                saveTextEl.textContent = 'ðŸ”„ Update Quote';
            } else {
                saveTextEl.textContent = 'ðŸ’¾ Save Quote';
            }
        }

        function handleInput(event) {
            const input = event.target;
            const id = input.dataset.id; 
            const field = input.dataset.field;
            const product = products.find(p => p.id === id);

            if (!product) return;

            let value = input.value;
            let isValid = true;
            let message = '';
            
            if (field === 'name') {
                product[field] = value;
            } else if (field === 'discountType') {
                product.discountValue = 0; // Reset discount value on type change
                product.discountType = value;
                product.isValid = true;
                updateUI();
                return; 
            } else {
                product[field] = parseFloat(value) || 0;
                
                if ((field === 'unitPrice' && product[field] < 0)) {
                    isValid = false;
                    message = `Product Price must be greater than or equal to zero.`;
                }
                
                if (field === 'units' && product[field] < 1) {
                    isValid = false;
                    message = `Units must be at least one.`;
                }


                if (field === 'discountValue' && product.discountType !== 'final') {
                    if (product[field] < 0) {
                        isValid = false;
                        message = "Discount value cannot be negative.";
                    }
                    if (product.discountType === 'percentage' && product[field] > 100) {
                        isValid = false;
                        message = "Percentage discount cannot exceed 100%.";
                    }
                }
            }

            product.isValid = isValid;

            // Re-render the specific input field to apply error class if needed
            const productRowEl = document.getElementById(`product-${id}`);
            if (productRowEl) {
                const affectedInput = productRowEl.querySelector(`[data-field="${field}"]`);
                if (affectedInput) {
                    if (isValid) {
                        affectedInput.classList.remove('input-error');
                    } else {
                        affectedInput.classList.add('input-error');
                        showMessage(message, 'warning');
                    }
                }
            }


            calculateProductTotal(id);
            updateGrandTotals(); // Update totals after every single product input change
        }

        function addProduct(startEmpty = false) {
            const newProduct = {
                id: crypto.randomUUID(), 
                name: startEmpty ? '' : `Product ${products.length + 1}`,
                unitPrice: 0.00,
                units: 1,
                discountType: 'percentage',
                discountValue: 0,
                subtotal: 0,
                discountAmount: 0,
                discountPercentage: 0,
                discountedPrice: 0,
                isValid: true, 
            };
            products.push(newProduct);
            calculateProductTotal(newProduct.id);
            updateUI();
            
            // Focus on the Unit Price input of the newly added product
            setTimeout(() => {
                const newProductEl = document.getElementById(`product-${newProduct.id}`);
                if (newProductEl) {
                    newProductEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Focus on 'unitPrice' as requested by the user
                    const unitPriceInput = newProductEl.querySelector(`[data-field="unitPrice"]`);
                    if (unitPriceInput) {
                        unitPriceInput.focus();
                        unitPriceInput.select(); 
                    }
                }
            }, 0);
        }

        function removeProduct(id) {
            products = products.filter(p => p.id !== id);
            if (products.length === 0) {
                addProduct(true);
            } else {
                updateUI();
            }
            showMessage("Product removed.", 'info');
        }
        
        // --- Drag and Drop Logic for Reordering ---
        let draggedId = null;

        function handleDragStart(e) {
            draggedId = e.currentTarget.dataset.id;
            e.dataTransfer.effectAllowed = 'move';
            // Set a transparent drag image for better control
            const img = new Image();
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            e.dataTransfer.setDragImage(img, 0, 0);

            // Add class for visual feedback
            setTimeout(() => e.currentTarget.classList.add('dragging'), 0);
        }
        
        // Prevent event from bubbling up to the drag handler if interacting with an input
        function handleDragClick(e) {
            e.stopPropagation();
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            const target = e.currentTarget;
            if (target.dataset.id !== draggedId) {
                // Simple visual feedback: highlight the drop zone
                target.classList.add('drag-over'); 
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetId = e.currentTarget.dataset.id;
            e.currentTarget.classList.remove('drag-over'); 

            if (draggedId === targetId) return;

            const dragIndex = products.findIndex(p => p.id === draggedId);
            const dropIndex = products.findIndex(p => p.id === targetId);

            if (dragIndex === -1 || dropIndex === -1) return;

            // Perform the swap/move
            const [draggedItem] = products.splice(dragIndex, 1);
            
            // Determine if dropping before or after the target
            const dropPosition = e.clientY < e.currentTarget.getBoundingClientRect().top + e.currentTarget.offsetHeight / 2 
                               ? dropIndex 
                               : dropIndex + 1;
            
            products.splice(dropPosition, 0, draggedItem);

            // Re-render the UI
            updateUI(); 
            showMessage("Product order updated.", 'info');
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging', 'drag-over');
            draggedId = null;
        }

        
        // --- LocalStorage Functions ---
        
        function getQuoteHistory() {
            try {
                const history = localStorage.getItem(QUOTE_HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                console.error("Error loading quote history from localStorage:", e);
                return [];
            }
        }

        function saveQuoteToLocalStorage() {
            const quoteName = currentQuoteName.trim();
            if (!quoteName) {
                showMessage("Please enter a name for the price quote.", 'error');
                quoteNameInputEl.focus();
                return;
            }
            
            const isAnyInvalid = products.some(p => p.isValid === false);
            if (isAnyInvalid) {
                showMessage("Cannot save: Please fix the invalid product inputs (highlighted in red).", 'error');
                return;
            }
            
            // Prepare data for saving (strip out transient calculated values, keep necessary data)
            const dataToSave = {
                name: quoteName,
                taxRate: globalTaxRate,
                currency: currentCurrency, // Save currency
                memo: currentMemo, // Save memo
                // Only save the essential product fields
                products: products.map(p => ({
                    name: p.name,
                    unitPrice: p.unitPrice,
                    units: p.units,
                    discountType: p.discountType,
                    discountValue: p.discountValue,
                })),
                updatedAt: new Date().toISOString(),
            };

            let history = getQuoteHistory();
            const action = currentQuoteId ? 'updated' : 'saved';

            if (currentQuoteId) {
                // Update existing quote
                const index = history.findIndex(q => q.id === currentQuoteId);
                if (index !== -1) {
                    history[index] = { ...history[index], ...dataToSave, id: currentQuoteId };
                }
            } else {
                // New quote
                currentQuoteId = crypto.randomUUID();
                history.push({ ...dataToSave, id: currentQuoteId, createdAt: dataToSave.updatedAt });
            }
            
            // Sort history by updated date, descending
            history.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            try {
                localStorage.setItem(QUOTE_HISTORY_KEY, JSON.stringify(history));
                showMessage(`Quote "${quoteName}" ${action} successfully!`, 'success');
                
                // Clear all fields after saving
                clearQuote(false); 

            } catch (e) {
                showMessage(`Error saving quote: Local storage limit reached?`, 'error');
                console.error("LocalStorage Save Error:", e);
            }
        }

        // Updated to use ID for lookup, making HTML generation simpler and more robust
        function loadQuoteFromLocalStorage(quoteId) {
            const history = getQuoteHistory();
            const quoteData = history.find(q => q.id === quoteId);

            if (!quoteData) {
                showMessage("Error: Quote not found in history. It may have been deleted.", 'error');
                renderHistoryList(); // Refresh list
                return;
            }
            
            // Set current quote metadata
            currentQuoteName = quoteData.name;
            currentQuoteId = quoteData.id;
            currentMemo = quoteData.memo || ''; 
            quoteNameInputEl.value = quoteData.name;
            quoteMemoInputEl.value = currentMemo; 
            
            // Load global tax rate
            globalTaxRate = parseFloat(quoteData.taxRate) || 0;
            globalTaxInputEl.value = globalTaxRate.toFixed(1);
            localStorage.setItem('globalTaxRate', globalTaxRate);
            
            // Load currency
            currentCurrency = quoteData.currency || 'â‚¹';
            currencySelectEl.value = currentCurrency;
            localStorage.setItem('currentCurrency', currentCurrency);
            
            const loadedProducts = quoteData.products || [];
            products = [];

            loadedProducts.forEach(p => {
                const newProduct = {
                    // Regenerate UUID for the current working session
                    id: crypto.randomUUID(), 
                    ...p,
                    // Reset calculated fields
                    subtotal: 0,
                    discountAmount: 0,
                    discountPercentage: 0,
                    discountedPrice: 0,
                    isValid: true, 
                };
                products.push(newProduct);
            });
            
            updateUI();
            showMessage(`Quote "${currentQuoteName}" loaded from history.`, 'info');
            closeHistoryModal();
        }

        // Updated to use ID for lookup, making HTML generation simpler and more robust
        function deleteQuoteFromLocalStorage(quoteId) {
            let history = getQuoteHistory();
            const quoteToDelete = history.find(q => q.id === quoteId);
            const name = quoteToDelete ? quoteToDelete.name : "Untitled Quote";

            history = history.filter(q => q.id !== quoteId);
            
            try {
                localStorage.setItem(QUOTE_HISTORY_KEY, JSON.stringify(history));
                showMessage(`Quote "${name}" deleted.`, 'success');
                
                if (currentQuoteId === quoteId) {
                    clearQuote(false); // Clear quote if it was the one currently loaded
                }

                renderHistoryList(); // Re-render the history modal immediately
            } catch (e) {
                showMessage(`Error deleting quote.`, 'error');
                console.error("LocalStorage Delete Error:", e);
            }
        }
        
        // --- Quote Management Functions ---

        function openHistoryModal() {
            historyModalEl.classList.add('open');
            historyModalEl.style.display = 'flex';
            renderHistoryList();
        }

        function closeHistoryModal() {
            historyModalEl.classList.remove('open');
            setTimeout(() => {
                historyModalEl.style.display = 'none';
            }, 300); // Match transition duration
        }
        
        function renderHistoryList() {
            const allQuotes = getQuoteHistory();
            const searchTerm = historySearchInputEl.value.toLowerCase().trim();
            
            const filteredQuotes = allQuotes.filter(quote => 
                quote.name.toLowerCase().includes(searchTerm)
            );

            historyListEl.innerHTML = '';
            
            if (filteredQuotes.length === 0) {
                historyEmptyStateEl.textContent = searchTerm ? "No quotes match your search." : "No saved quotes found locally.";
                historyEmptyStateEl.classList.remove('hidden');
                return;
            } else {
                historyEmptyStateEl.classList.add('hidden');
            }
            
            filteredQuotes.forEach(quote => {
                const quoteEl = document.createElement('div');
                quoteEl.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 shadow-sm border border-gray-200';
                
                // Format the ISO string date
                const updatedDate = new Date(quote.updatedAt);
                const timeString = updatedDate.toLocaleString('en-IN', {
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', hour12: true
                });
                
                const currencySymbol = quote.currency || 'â‚¹';
                const hasMemo = quote.memo && quote.memo.trim().length > 0;

                // IMPORTANT FIX: Passing only the simple ID string for robustness
                quoteEl.innerHTML = `
                    <div class="flex flex-col truncate pr-2">
                        <span class="font-bold text-gray-800 truncate">${quote.name}</span>
                        <span class="text-xs text-gray-500">${currencySymbol} | Tax: ${quote.taxRate.toFixed(1)}% ${hasMemo ? '| ðŸ“' : ''}</span>
                        <span class="text-xs text-gray-500">Updated: ${timeString}</span>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button onclick="loadQuoteFromLocalStorage('${quote.id}')" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-1 px-3 rounded-md transition duration-150 shadow-sm">
                            Load
                        </button>
                        <button onclick="deleteQuoteFromLocalStorage('${quote.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                historyListEl.appendChild(quoteEl);
            });
        }


        function setCurrentQuoteName(name) {
            currentQuoteName = name.trim();
        }

        function clearQuote(showMsg = true) {
            products = [];
            currentQuoteName = '';
            currentQuoteId = null; 
            currentMemo = ''; // Clear memo
            quoteNameInputEl.value = '';
            quoteMemoInputEl.value = ''; // Clear memo input
            
            // Reset global tax rate UI
            globalTaxRate = 0;
            globalTaxInputEl.value = 0;
            localStorage.setItem('globalTaxRate', 0);
            
            // Reset currency to default (optional, but safe)
            currentCurrency = 'â‚¹';
            currencySelectEl.value = 'â‚¹';
            localStorage.setItem('currentCurrency', 'â‚¹');
            
            if (showMsg) {
                 showMessage("Quote cleared. Ready for a new quote!", 'info');
            }
            addProduct(true); 
        }
        
        // --- Copy/Share Functions ---
        
        function generateWhatsappSummaryText() {
            // BUG FIX: Ensure all products are calculated and state is fresh 
            // before generating the summary text from the 'products' state.
            recalculateAllProducts(); 
            const totals = updateGrandTotals(); 
            const format = (value) => `${currentCurrency}${value.toFixed(2)}`;
            
            const memoText = currentMemo.trim();
            // NEW FIX: Move memo section to the end of the summary text
            const memoSection = memoText ? `\n\n*--- MEMO ---*\n${memoText}` : '';
            
            const productDetails = products.map((product, index) => {
                const productNumber = index + 1;
                const name = product.name || 'Untitled Product';

                return `
*${productNumber}. ${name}*
    Unit Price: ${format(product.unitPrice)}
    Units: ${product.units}
    Subtotal: ${format(product.subtotal)}
    _Discount Applied:_ -${format(product.discountAmount)} (${product.discountPercentage.toFixed(2)}%)
    *Product Final Price: ${format(product.discountedPrice)}*`; 
            }).join('\n');

            const summary = `
*ðŸ’° PRICE QUOTE SUMMARY*
${currentQuoteName ? `*Quote Name:* ${currentQuoteName}\n` : ''}_Currency: ${currentCurrency} | Prepared using Discount Calculator Pro_

*--- PRODUCT DETAILS ---*
${productDetails}

*--- GRAND TOTAL ---*

Total Subtotal: *${format(totals.totalSubtotal)}*
Total Savings: *-${format(totals.totalDiscount)}*
Net Amount (Before Tax): *${format(totals.netPayableAmount)}*
Tax Applied (${totals.globalTaxRate.toFixed(1)}%): *+${format(totals.taxAmount)}*
*NET PAYABLE AMOUNT (INCL. TAX): ${format(totals.grandTotal)}*${memoSection}`; // Memo section placed at the end of the main summary text
            return summary.trim();
        }
        
        function shareToWhatsapp() {
            const encodedText = encodeURIComponent(generateWhatsappSummaryText());
            // const appLink = `\n\nGenerated with Discount Calculator Pro.`;
            const whatsappUrl = `https://wa.me/?text=${encodedText}${encodeURIComponent(appLink)}`;
            window.open(whatsappUrl, '_blank');
        }

        function copyToClipboard() {
            const summaryText = generateWhatsappSummaryText(); 
            const copyButton = document.getElementById('copy-quote-btn');
            
            // const fullTextToCopy = summaryText + `\n\nGenerated with Discount Calculator Pro.`;

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = fullTextToCopy;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.top = '0';
            tempTextArea.style.left = '0';
            tempTextArea.style.opacity = '0';
            
            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();

            let successful = false;
            try {
                successful = document.execCommand('copy');
            } catch (err) {
                console.error('Copy command failed:', err);
            }
            document.body.removeChild(tempTextArea);
            
            if (successful) {
                const originalContent = copyButton.innerHTML;
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> <span class="text-lg">Copied!</span>`;
                copyButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                copyButton.classList.add('bg-blue-500', 'hover:bg-blue-600'); 

                setTimeout(() => {
                    copyButton.innerHTML = originalContent;
                    copyButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    copyButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                }, 2000);
            } else {
                showMessage('Failed to copy text automatically. Try long-pressing the text.', 'error');
            }
        }


        // --- Initialization ---
        
        window.onload = function() {
            // Load tax rate from local storage
            const savedTax = localStorage.getItem('globalTaxRate');
            if (savedTax !== null) {
                globalTaxRate = parseFloat(savedTax) || 0;
                globalTaxInputEl.value = globalTaxRate.toFixed(1);
            }
            
            // Load currency from local storage
            const savedCurrency = localStorage.getItem('currentCurrency');
            if (savedCurrency && currencySelectEl.querySelector(`option[value="${savedCurrency}"]`)) {
                currentCurrency = savedCurrency;
                currencySelectEl.value = currentCurrency;
            } else {
                 currentCurrency = 'â‚¹'; // Default if not found or invalid
            }
            
            // Start with one product row
            if (products.length === 0) {
                 addProduct(true); 
            } else {
                updateUI(); 
            }
        }
    </script>
</body>
</html>

